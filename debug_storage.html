"use client";

import React, { useState, useMemo, useEffect } from 'react';
import { DndContext, DragEndEvent, useDraggable, useDroppable, DragOverlay } from '@dnd-kit/core';
import { 
  LayoutDashboard, Calendar, Settings, X, AlertTriangle, Search, FileDown, 
  Trash2, Split, Users, MapPin, Plus, Database 
} from 'lucide-react';
import { toPng } from 'html-to-image';
import jsPDF from 'jspdf';

// --- TYPES ---
export interface AssignmentRow {
  id: string;
  subject: string;
  subjectLabel: string;
  type: string; // 'CM', 'TD', 'TP'
  mainGroup: string;
  sharedGroups: string[];
  subLabel: string;
  teacher: string;
  room: string;
  semester: string;
}

// --- CONSTANTS & MOCK DATA ---
const DAYS = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
const SEMESTERS = ['S1', 'S2', 'S3', 'S4'];
const ALL_ROOMS = ['101', '102', '201', '202', 'Amphi A', 'Amphi B', 'Labo 1'];

// Données initiales par défaut si le localStorage est vide
const INITIAL_SUBJECTS = [
    {
        semestre: 'S1',
        matieres: [
            { code: 'MATH101', libelle: 'Analyse 1', enseignantsCM: 'Dr. Alpha', enseignantsTD: 'M. Beta' },
            { code: 'INFO101', libelle: 'Algo & Prog', enseignantsCM: 'Pr. Turing', enseignantsTD: 'Mme. Lovelace' },
            { code: 'PHYS101', libelle: 'Mécanique', enseignantsCM: 'Dr. Newton', enseignantsTD: 'M. Einstein' },
        ]
    }
];

export default function App() {
    const [isClient, setIsClient] = useState(false);
    
    // --- STATE PRINCIPAL ---
    const [semester, setSemester] = useState<string>('S1');
    const [activeTab, setActiveTab] = useState<'manage' | 'planning' | 'config' | 'data'>('planning'); 
    const [activeMainGroup, setActiveMainGroup] = useState("Groupe 1");
    const [currentWeek, setCurrentWeek] = useState(1);
    const [searchQuery, setSearchQuery] = useState("");
    const [isExporting, setIsExporting] = useState(false);
    const [toastMessage, setToastMessage] = useState<{msg: string, type: 'error' | 'success'} | null>(null);
    const [manageFilterCode, setManageFilterCode] = useState<string>("");
    
    // États pour la gestion des données
    const [dataSubTab, setDataSubTab] = useState<'rooms' | 'subjects' | 'progress'>('subjects');
    const [showDataMenu, setShowDataMenu] = useState(false);
    
    // État des cours et du planning
    const [assignmentRows, setAssignmentRows] = useState<AssignmentRow[]>([]);
    const [schedule, setSchedule] = useState<Record<string, string | null>>({});
    const [activeDragItem, setActiveDragItem] = useState<AssignmentRow | null>(null);
    const [refreshKey, setRefreshKey] = useState(0); 
    
    // Données modifiables
    const [customRooms, setCustomRooms] = useState<string[]>([...ALL_ROOMS]);
    const [customSubjects, setCustomSubjects] = useState(INITIAL_SUBJECTS);
    
    // Configuration
    const [config, setConfig] = useState({
        startDate: '2024-09-02',
        totalWeeks: 16,
        numberOfGroups: 4,
        vacationPeriods: [] as Array<{startDate: string, endDate: string}>,
        timeSlots: ['08:00-09:30', '09:45-11:15', '11:30-13:00', '14:00-15:30', '15:45-17:15']
    });

    // --- INITIALISATION ---
    useEffect(() => {
        setIsClient(true);
        const savedConfig = localStorage.getItem('supnum_config_v67');
        if (savedConfig) setConfig(JSON.parse(savedConfig));

        const savedAssignmentRows = localStorage.getItem('supnum_assignment_rows');
        if (savedAssignmentRows) {
            setAssignmentRows(JSON.parse(savedAssignmentRows));
        } else {
            // Chargement initial si vide
            loadFullDataset(false); 
        }

        const savedSchedule = localStorage.getItem('supnum_schedule');
        if (savedSchedule) setSchedule(JSON.parse(savedSchedule));
    }, []);

    // --- SAUVEGARDES AUTOMATIQUES ---
    useEffect(() => {
        if (!isClient) return;
        if (assignmentRows.length > 0) localStorage.setItem('supnum_assignment_rows', JSON.stringify(assignmentRows));
        localStorage.setItem('supnum_schedule', JSON.stringify(schedule));
        localStorage.setItem('supnum_config_v67', JSON.stringify(config));
    }, [assignmentRows, schedule, config, isClient]);

    // --- COMPUTED VALUES ---
    const dynamicGroups = useMemo(() => {
        return Array.from({ length: config.numberOfGroups }, (_, i) => `Groupe ${i + 1}`);
    }, [config.numberOfGroups]);

    const UNIQUE_TEACHERS = useMemo(() => {
        const set = new Set<string>();
        customSubjects.forEach((sem: any) => 
            sem.matieres.forEach((m: any) => {
                if(m.enseignantsCM) m.enseignantsCM.split('/').forEach((t:any) => set.add(t.trim()));
                if(m.enseignantsTD) m.enseignantsTD.split('/').forEach((t:any) => set.add(t.trim()));
            })
        );
        return Array.from(set).sort();
    }, [customSubjects]);

    // --- ACTIONS ---

    const loadFullDataset = (confirmAction = true) => {
        if (confirmAction && !confirm("Réinitialiser toutes les données ?")) return;
        
        const newRows: AssignmentRow[] = [];
        const groupsToGen = Array.from({ length: 4 }, (_, i) => `Groupe ${i + 1}`);

        customSubjects.forEach((semData: any) => {
            semData.matieres.forEach((matiere: any) => {
                groupsToGen.forEach(group => {
                    // CM
                    newRows.push({ 
                        id: Math.random().toString(36).substr(2, 9), 
                        subject: matiere.code, 
                        subjectLabel: matiere.libelle, 
                        type: 'CM', 
                        mainGroup: group, 
                        sharedGroups: [group], 
                        subLabel: 'CM', 
                        teacher: matiere.enseignantsCM || '', 
                        room: 'Amphi A', 
                        semester: semData.semestre 
                    });
                    // TD
                    newRows.push({ 
                        id: Math.random().toString(36).substr(2, 9), 
                        subject: matiere.code, 
                        subjectLabel: matiere.libelle, 
                        type: 'TD', 
                        mainGroup: group, 
                        sharedGroups: [group], 
                        subLabel: 'TD', 
                        teacher: matiere.enseignantsTD || '', 
                        room: '101', 
                        semester: semData.semestre 
                    });
                });
            });
        });
        setAssignmentRows(newRows);
        setSchedule({});
    };

    const updateRow = (id: string, field: keyof AssignmentRow, value: any) => {
        setAssignmentRows(prev => {
            return prev.map(r => {
                if (r.id === id) {
                    // CORRECTION ICI : Si on change le type, on change aussi le subLabel
                    if (field === 'type') {
                        return { ...r, type: value, subLabel: value };
                    }
                    return { ...r, [field]: value };
                }
                return r;
            });
        });
        setRefreshKey(prev => prev + 1);
    };

    const handleUnassign = (courseId: string) => {
        setSchedule(prev => {
            const next = { ...prev };
            Object.keys(next).forEach(k => { if (next[k] === courseId) next[k] = null; });
            return next;
        });
    };

    const handleExportPDF = async () => {
        const element = document.getElementById('calendar-capture-zone');
        if (!element) return;
        setIsExporting(true);
        try {
            const dataUrl = await toPng(element, { quality: 1.0, pixelRatio: 2, backgroundColor: "#ffffff" });
            const pdf = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const imgProps = pdf.getImageProperties(dataUrl);
            const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
            pdf.addImage(dataUrl, 'PNG', 0, 10, pdfWidth, pdfHeight);
            pdf.save(`Planning_${semester}_${activeMainGroup}.pdf`);
        } catch (err) { alert("Erreur export PDF"); } finally { setIsExporting(false); }
    };

    const checkInstantConflict = (courseId: string, day: string, time: string): string | null => {
        const slotKey = `${semester}|w${currentWeek}|${activeMainGroup}|${day}|${time}`;
        const existingCourse = schedule[slotKey];
        if (existingCourse && existingCourse !== courseId) {
            return "Créneau occupé !";
        }
        return null;
    };

    const handleDragEnd = (e: DragEndEvent) => {
        setActiveDragItem(null);
        const { active, over } = e;
        if (!over) return;

        const sourceId = active.id as string;
        const targetTimeSlot = over.id as string; // format: semester|week|group|day|time
        
        // Extraction day/time
        const parts = targetTimeSlot.split('|');
        if (parts.length < 5) return;
        const [,, , tDay, tTime] = parts;

        const conflictMsg = checkInstantConflict(sourceId, tDay, tTime);
        if (conflictMsg) {
            setToastMessage({ msg: conflictMsg, type: 'error' });
            return;
        }

        setSchedule(prev => {
            const next = { ...prev };
            // Enlever de l'ancien emplacement
            Object.keys(next).forEach(k => { 
                if (k.startsWith(`${semester}|w${currentWeek}|${activeMainGroup}|`) && next[k] === sourceId) {
                    next[k] = null; 
                }
            });
            // Assigner au nouveau
            next[targetTimeSlot] = sourceId;
            return next;
        });
    };

    // --- RENDER HELPERS ---
    if (!isClient) return <div className="p-10 text-center">Chargement...</div>;

    const groupCourses = assignmentRows.filter(r => r.mainGroup === activeMainGroup && r.semester === semester);
    const placedIdsThisWeek = Object.keys(schedule)
        .filter(k => k.startsWith(`${semester}|w${currentWeek}|${activeMainGroup}|`) && schedule[k])
        .map(k => schedule[k]);
    const sidebarCourses = groupCourses.filter(c => !placedIdsThisWeek.includes(c.id));
    const gridTemplate = `40px repeat(${config.timeSlots.length}, minmax(0, 1fr))`;

    return (
        <div className="h-screen flex flex-col bg-slate-50 text-slate-900 overflow-hidden font-sans">
            {/* TOAST */}
            {toastMessage && (
                <div className="absolute top-20 left-1/2 -translate-x-1/2 z-[9999]">
                    <div className={`px-4 py-2 rounded-lg shadow-xl font-bold text-white flex items-center gap-2 ${toastMessage.type === 'error' ? 'bg-red-600' : 'bg-green-600'}`}>
                        <AlertTriangle size={18}/>
                        <span className="text-xs">{toastMessage.msg}</span>
                        <button onClick={() => setToastMessage(null)}><X size={14}/></button>
                    </div>
                </div>
            )}

            {/* HEADER */}
            <HeaderBanner 
                semester={semester} setSemester={setSemester}
                group={activeMainGroup} setGroup={setActiveMainGroup}
                week={currentWeek} setWeek={setCurrentWeek}
                totalWeeks={config.totalWeeks}
                dynamicGroups={dynamicGroups}
                handleExportPDF={handleExportPDF} isExporting={isExporting}
            />

            <div className="flex flex-1 overflow-hidden"> 
                {/* SIDEBAR NAVIGATION */}
                <aside className="w-14 bg-slate-900 text-slate-400 flex flex-col items-center py-4 gap-6 shrink-0 z-30">
                    <NavButton active={activeTab === 'planning'} onClick={() => setActiveTab('planning')} icon={<Calendar size={20}/>} label="Planning" />
                    <NavButton active={activeTab === 'manage'} onClick={() => setActiveTab('manage')} icon={<LayoutDashboard size={20}/>} label="Gestion" />
                    
                    <div className="relative data-menu-container">
                        <NavButton active={activeTab === 'data'} onClick={() => setShowDataMenu(!showDataMenu)} icon={<Database size={20}/>} label="Données" />
                        {showDataMenu && (
                            <div className="absolute left-14 top-0 bg-white rounded-lg shadow-xl border border-slate-200 py-2 w-48 flex flex-col gap-1 z-50">
                                <MenuOption label="Matières & Profs" active={dataSubTab === 'subjects'} onClick={() => { setDataSubTab('subjects'); setActiveTab('data'); setShowDataMenu(false); }} />
                                <MenuOption label="Salles" active={dataSubTab === 'rooms'} onClick={() => { setDataSubTab('rooms'); setActiveTab('data'); setShowDataMenu(false); }} />
                            </div>
                        )}
                    </div>
                    <div className="flex-1" />
                    <NavButton active={activeTab === 'config'} onClick={() => setActiveTab('config')} icon={<Settings size={20}/>} label="Config" />
                </aside>

                <main className="flex-1 overflow-hidden relative bg-slate-100/50">
                    <DndContext onDragEnd={handleDragEnd}>
                        
                        {/* --- TAB: PLANNING --- */}
                        {activeTab === 'planning' && (
                            <div className="h-full flex">
                                {/* Cours à placer */}
                                <div className="w-64 bg-white border-r border-slate-200 flex flex-col shadow-sm z-20">
                                    <div className="p-4 border-b border-slate-100 bg-slate-50/50">
                                        <h3 className="font-bold text-slate-700 text-sm flex items-center gap-2">
                                            <Split size={16} className="text-blue-500"/>
                                            À placer <span className="bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full text-[10px]">{sidebarCourses.length}</span>
                                        </h3>
                                    </div>
                                    <div className="flex-1 overflow-y-auto p-3 space-y-2">
                                        {sidebarCourses.map(course => (
                                            <DraggableSourceItem key={course.id} course={course} />
                                        ))}
                                    </div>
                                </div>

                                {/* Grille */}
                                <div className="flex-1 overflow-auto bg-slate-50/30 p-4" id="calendar-capture-zone">
                                    <div className="min-w-[800px] bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                                        {/* Header Heures */}
                                        <div className="grid border-b border-slate-200 bg-slate-50" style={{ gridTemplateColumns: gridTemplate }}>
                                            <div className="p-3 border-r border-slate-200 bg-slate-100"></div>
                                            {config.timeSlots.map((slot, i) => (
                                                <div key={i} className="p-2 text-center border-r border-slate-100 font-bold text-slate-700 text-xs">
                                                    {slot}
                                                </div>
                                            ))}
                                        </div>

                                        {/* Lignes Jours */}
                                        {DAYS.map((day) => (
                                            <div key={day} className="grid border-b border-slate-100 min-h-[100px]" style={{ gridTemplateColumns: gridTemplate }}>
                                                <div className="p-2 border-r border-slate-200 bg-slate-50 flex items-center justify-center">
                                                    <div className="writing-vertical-rl transform -rotate-180 text-xs font-bold text-slate-500 uppercase tracking-widest">
                                                        {day.substring(0, 3)}
                                                    </div>
                                                </div>
                                                {config.timeSlots.map((time) => {
                                                    const slotId = `${semester}|w${currentWeek}|${activeMainGroup}|${day}|${time}`;
                                                    const courseId = schedule[slotId];
                                                    const course = courseId ? assignmentRows.find(r => r.id === courseId) : null;
                                                    return (
                                                        <DroppableCell key={slotId} id={slotId} isOccupied={!!course}>
                                                            {course && (
                                                                <DraggableCourseCard 
                                                                    course={course} 
                                                                    onUnassign={() => handleUnassign(course.id)}
                                                                    updateRow={updateRow}
                                                                    uniqueTeachers={UNIQUE_TEACHERS}
                                                                    customRooms={customRooms}
                                                                />
                                                            )}
                                                        </DroppableCell>
                                                    );
                                                })}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}

                        <DragOverlay>
                            {activeDragItem ? <CourseCardContent course={activeDragItem} isOverlay /> : null}
                        </DragOverlay>
                    </DndContext>

                    {/* --- TAB: MANAGE (Table View) --- */}
                    {activeTab === 'manage' && (
                        <div className="h-full flex flex-col p-6 overflow-hidden">
                            <div className="flex justify-between items-center mb-6">
                                <h2 className="text-2xl font-bold text-slate-800">Gestion des cours</h2>
                                <div className="flex gap-2">
                                    <input 
                                        type="text" placeholder="Filtrer..." 
                                        className="px-4 py-2 border rounded-lg text-sm"
                                        value={manageFilterCode} onChange={(e) => setManageFilterCode(e.target.value)}
                                    />
                                    <button onClick={() => loadFullDataset(true)} className="flex items-center gap-2 px-4 py-2 bg-red-50 text-red-600 rounded-lg text-sm font-bold hover:bg-red-100">
                                        <Trash2 size={16}/> Reset
                                    </button>
                                </div>
                            </div>
                            
                            <div className="bg-white rounded-xl shadow-sm border border-slate-200 flex-1 overflow-auto">
                                <table className="w-full text-left text-sm">
                                    <thead className="bg-slate-50 border-b sticky top-0 z-10">
                                        <tr>
                                            <th className="p-4 text-slate-600">Matière</th>
                                            <th className="p-4 text-slate-600">Groupe</th>
                                            <th className="p-4 text-slate-600">Type</th>
                                            <th className="p-4 text-slate-600">Professeur</th>
                                            <th className="p-4 text-slate-600">Salle</th>
                                            <th className="p-4 text-slate-600 text-right">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100">
                                        {assignmentRows
                                            .filter(r => r.subject.toLowerCase().includes(manageFilterCode.toLowerCase()))
                                            .map(row => (
                                            <tr key={row.id} className="hover:bg-slate-50">
                                                <td className="p-4">
                                                    <div className="font-bold text-slate-800">{row.subject}</div>
                                                    <div className="text-xs text-slate-500">{row.subjectLabel}</div>
                                                </td>
                                                <td className="p-4 text-slate-600">{row.mainGroup}</td>
                                                <td className="p-4">
                                                    <select 
                                                        value={row.type} 
                                                        onChange={(e) => updateRow(row.id, 'type', e.target.value)}
                                                        className="bg-transparent font-bold text-blue-600 outline-none cursor-pointer border rounded px-2 py-1"
                                                    >
                                                        <option value="CM">CM</option>
                                                        <option value="TD">TD</option>
                                                        <option value="TP">TP</option>
                                                    </select>
                                                </td>
                                                <td className="p-4">
                                                    <select 
                                                        value={row.teacher} 
                                                        onChange={(e) => updateRow(row.id, 'teacher', e.target.value)}
                                                        className="w-full bg-transparent border-b border-transparent hover:border-slate-300 focus:border-blue-500 outline-none"
                                                    >
                                                        <option value="">(Non défini)</option>
                                                        {UNIQUE_TEACHERS.map(t => <option key={t} value={t}>{t}</option>)}
                                                    </select>
                                                </td>
                                                <td className="p-4">
                                                    <select 
                                                        value={row.room} 
                                                        onChange={(e) => updateRow(row.id, 'room', e.target.value)}
                                                        className="w-24 bg-transparent border-b border-transparent hover:border-slate-300 focus:border-blue-500 outline-none"
                                                    >
                                                        {customRooms.map(r => <option key={r} value={r}>{r}</option>)}
                                                    </select>
                                                </td>
                                                <td className="p-4 text-right">
                                                    <button onClick={() => setAssignmentRows(prev => prev.filter(r => r.id !== row.id))} className="text-red-400 hover:text-red-600 p-2">
                                                        <Trash2 size={16}/>
                                                    </button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}

                    {/* --- TAB: CONFIG --- */}
                    {activeTab === 'config' && (
                        <div className="p-8 max-w-4xl mx-auto h-full overflow-auto">
                            <h2 className="text-2xl font-bold text-slate-800 mb-8 flex items-center gap-2">
                                <Settings className="text-blue-600"/> Configuration
                            </h2>
                            <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 mb-6">
                                <h3 className="font-bold text-lg mb-4 text-slate-700">Paramètres Généraux</h3>
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 mb-1">Nombre de Groupes</label>
                                        <input type="number" value={config.numberOfGroups} onChange={(e) => setConfig({...config, numberOfGroups: parseInt(e.target.value)})} className="w-full p-2 border rounded" />
                                    </div>
                                </div>
                            </div>
                             <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                                <h3 className="font-bold text-lg mb-4 text-slate-700">Créneaux Horaires</h3>
                                <div className="space-y-2">
                                    {config.timeSlots.map((slot, idx) => (
                                        <div key={idx} className="flex gap-2 items-center">
                                            <input value={slot} onChange={(e) => {
                                                const newSlots = [...config.timeSlots];
                                                newSlots[idx] = e.target.value;
                                                setConfig({...config, timeSlots: newSlots});
                                            }} className="flex-1 p-2 border rounded font-mono text-sm"/>
                                            <button onClick={() => setConfig({...config, timeSlots: config.timeSlots.filter((_, i) => i !== idx)})} className="text-red-400"><X size={16}/></button>
                                        </div>
                                    ))}
                                    <button onClick={() => setConfig({...config, timeSlots: [...config.timeSlots, "00:00-00:00"]})} className="text-blue-600 font-bold text-sm flex items-center gap-1"><Plus size={14}/> Ajouter</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* --- TAB: DATA --- */}
                    {activeTab === 'data' && (
                        <div className="p-6 h-full flex flex-col">
                            <h2 className="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-2">
                                <Database className="text-blue-600"/> Données: {dataSubTab === 'rooms' ? 'Salles' : 'Matières'}
                            </h2>
                            {dataSubTab === 'rooms' && (
                                <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex-1 overflow-auto">
                                    <div className="flex flex-wrap gap-3">
                                        {customRooms.map((room, idx) => (
                                            <div key={idx} className="bg-slate-50 border px-3 py-1 rounded-lg flex items-center gap-2 group">
                                                <span className="font-bold text-slate-700">{room}</span>
                                                <button onClick={() => setCustomRooms(prev => prev.filter((_, i) => i !== idx))} className="text-slate-400 hover:text-red-500"><X size={14}/></button>
                                            </div>
                                        ))}
                                        <button onClick={() => { const r = prompt("Nom ?"); if(r) setCustomRooms(prev => [...prev, r]); }} className="px-3 py-1 border border-dashed rounded-lg text-blue-500 hover:bg-blue-50 flex items-center gap-1"><Plus size={14}/> Ajouter</button>
                                    </div>
                                </div>
                            )}
                             {dataSubTab === 'subjects' && (
                                <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex-1 flex flex-col">
                                    <textarea className="flex-1 font-mono text-xs bg-slate-900 text-green-400 p-4 rounded-lg resize-none" value={JSON.stringify(customSubjects, null, 2)} onChange={(e) => { try { setCustomSubjects(JSON.parse(e.target.value)); } catch(e) {} }} />
                                </div>
                             )}
                        </div>
                    )}
                </main>
            </div>
        </div>
    );
}

// --- SOUS-COMPOSANTS ---

const HeaderBanner = ({ semester, setSemester, group, setGroup, week, setWeek, totalWeeks, dynamicGroups, handleExportPDF, isExporting }: any) => (
    <div className="flex flex-col bg-white shadow-sm z-40 border-b border-slate-200">
        <div className="flex items-center justify-between h-14 bg-slate-800 px-6 text-white">
            <h1 className="text-lg font-bold">University Scheduler</h1>
            <div className="flex items-center gap-4">
                 <select value={semester} onChange={(e) => setSemester(e.target.value)} className="bg-slate-700 text-white text-xs p-1 rounded">
                    {SEMESTERS.map(s => <option key={s} value={s}>{s}</option>)}
                </select>
                <select value={group} onChange={(e) => setGroup(e.target.value)} className="bg-slate-700 text-white text-xs p-1 rounded">
                    {dynamicGroups.map((g: string) => <option key={g} value={g}>{g}</option>)}
                </select>
                <select value={week} onChange={(e) => setWeek(parseInt(e.target.value))} className="bg-slate-700 text-white text-xs p-1 rounded">
                    {Array.from({ length: totalWeeks }, (_, i) => <option key={i+1} value={i+1}>Semaine {i+1}</option>)}
                </select>
                <button onClick={handleExportPDF} disabled={isExporting} className="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded text-xs flex items-center gap-1">
                    <FileDown size={14}/> PDF
                </button>
            </div>
        </div>
    </div>
);

function NavButton({ active, onClick, icon, label }: any) {
    return (
        <button onClick={onClick} className={`p-2 rounded-xl transition-colors ${active ? 'bg-blue-600 text-white shadow-lg' : 'hover:bg-slate-800'}`} title={label}>
            {icon}
        </button>
    );
}

function MenuOption({ label, active, onClick }: any) {
    return (
        <button onClick={onClick} className={`px-4 py-2 text-left text-xs font-bold hover:bg-slate-50 ${active ? 'text-blue-600 bg-blue-50' : 'text-slate-600'}`}>
            {label}
        </button>
    );
}

function DraggableSourceItem({ course }: { course: AssignmentRow }) {
    const { attributes, listeners, setNodeRef, isDragging } = useDraggable({ id: course.id, data: { course } });
    if (isDragging) return <div ref={setNodeRef} className="opacity-30 p-2 mb-2 bg-slate-100 border border-dashed rounded h-16"></div>;
    return <div ref={setNodeRef} {...listeners} {...attributes} className="cursor-grab hover:scale-[1.02] active:scale-95 transition-transform"><CourseCardContent course={course} /></div>;
}

function DraggableCourseCard({ course, onUnassign, updateRow, uniqueTeachers, customRooms }: any) {
    const { attributes, listeners, setNodeRef, isDragging } = useDraggable({ id: course.id, data: { course } });
    if (isDragging) return <div className="w-full h-full opacity-0" ref={setNodeRef}></div>;
    return (
        <div className="relative w-full h-full group" ref={setNodeRef} {...attributes}>
            <div {...listeners} className="w-full h-full cursor-grab">
                <CourseCardContent course={course} isPlaced updateRow={updateRow} uniqueTeachers={uniqueTeachers} customRooms={customRooms}/>
            </div>
            <button onClick={(e) => { e.stopPropagation(); onUnassign(); }} className="absolute -top-1 -right-1 bg-red-500 text-white rounded-full p-0.5 opacity-0 group-hover:opacity-100 z-10"><X size={10} /></button>
        </div>
    );
}

function DroppableCell({ id, children, isOccupied }: any) {
    const { setNodeRef, isOver } = useDroppable({ id });
    return (
        <div ref={setNodeRef} className={`relative min-h-[90px] p-1 border-r border-slate-100 transition-all ${isOver ? 'bg-blue-50 ring-2 ring-inset ring-blue-400' : ''} ${!isOccupied ? 'hover:bg-slate-50' : ''}`}>
            {children}
        </div>
    );
}

function CourseCardContent({ course, isPlaced = false, isOverlay = false, updateRow, uniqueTeachers, customRooms }: any) {
    const typeColors: Record<string, string> = {
        'CM': 'bg-amber-100 border-amber-200 text-amber-900',
        'TD': 'bg-sky-100 border-sky-200 text-sky-900',
        'TP': 'bg-purple-100 border-purple-200 text-purple-900',
    };
    const baseClass = typeColors[course.type] || 'bg-slate-100 border-slate-200 text-slate-800';

    return (
        <div className={`w-full h-full rounded-lg border shadow-sm p-1.5 flex flex-col gap-0.5 overflow-hidden text-[10px] leading-tight select-none ${baseClass} ${isOverlay ? 'shadow-xl w-40 h-24' : ''}`}>
            <div className="flex justify-between items-start">
                <span className="font-extrabold uppercase tracking-tight line-clamp-1 flex-1">{course.subject}</span>
                {/* CORRECTION : Affiche dynamiquement le type/subLabel */}
                <span className="opacity-60 font-mono text-[9px]">{course.type}</span>
            </div>
            <div className="line-clamp-2 opacity-80 text-[9px] italic mb-auto">{course.subjectLabel}</div>

            {isPlaced && !isOverlay ? (
                <div className="mt-1 space-y-0.5" onMouseDown={e => e.stopPropagation()}>
                    <select value={course.teacher} onChange={(e) => updateRow(course.id, 'teacher', e.target.value)} className="w-full bg-white/40 rounded px-0.5 border-none text-[9px] font-bold outline-none cursor-pointer">
                        <option value="">Pro?</option>
                        {uniqueTeachers?.map((t: string) => <option key={t} value={t}>{t}</option>)}
                    </select>
                    <select value={course.room} onChange={(e) => updateRow(course.id, 'room', e.target.value)} className="w-full bg-white/40 rounded px-0.5 border-none text-[9px] font-bold outline-none cursor-pointer">
                         <option value="">Sal?</option>
                         {customRooms?.map((r: string) => <option key={r} value={r}>{r}</option>)}
                    </select>
                </div>
            ) : (
                <div className="mt-1 opacity-70 flex flex-col">
                     <span className="font-bold truncate"><Users size={8} className="inline mr-1"/>{course.teacher || '?'}</span>
                     <span className="font-bold truncate"><MapPin size={8} className="inline mr-1"/>{course.room || '?'}</span>
                </div>
            )}
        </div>
    );
}